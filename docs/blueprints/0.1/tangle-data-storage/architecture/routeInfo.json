{"path":"docs/blueprints/0.1/tangle-data-storage/architecture","templateID":1,"sharedPropsHashes":{},"localProps":{"markdown":"# Application architecture\n\n**The Tangle data storage application consists of two parts: A graphical user interface (GUI), written in React and a back-end API, written in NodeJS.**\n\n:::warning:Disclaimer\nRunning an open source project, like any human endeavor, involves uncertainty and trade-offs. We hope the architecture described below helps you to deploy similar systems, but it may include mistakes, and can’t address every situation. If you have any questions about your project, we encourage you to do your own research, seek out experts, and discuss them with the IOTA community.\n:::\n\n## Prerequisites\n\nThis projects assumes some level of programming knowledge, specifically in: JavaScript, React and Node.js.\n\n## Instructions and technical concepts \n\n- [PoC source code](https://github.com/iotaledger/poc-ipfs/blob/master/README.md) - \nConsists of two parts a front-end GUI written in React and a back-end written as a Node.js API.\nIn order to reproduce this PoC there is no requirement to deploy dedicated hardware.\n- [Front-end deployment instructions](https://github.com/iotaledger/poc-ipfs/blob/master/client/DEPLOYMENT.md)\n- [Node.js API deployment instructions](https://github.com/iotaledger/poc-ipfs/blob/master/api/DEPLOYMENT.md)\n\nThe presented infrastructure makes use of the IOTA Tangle and an `InterPlanetary File System` (IPFS) node that you run yourself. The following image shows the main architecture components.\n\n![Data Storage PoC - IOTA/IPFS - Architecture](/assets/docs/blueprints/0.1/images/data-storage-ipfs.png)\n\n:::warning:Disclaimer\nRunning an open source project, like any human endeavor, involves uncertainty and trade-offs. We hope the architecture described below helps you to deploy similar systems, but it may include mistakes, and can’t address every situation. If you have any questions about your project, we encourage you to do your own research, seek out experts, and discuss them with the IOTA community.\n:::\n\n## Prerequisites\n\nTo test, edit, and deploy this application, you need programming knowledge in JavaScript, React, and NodeJS.\n\n## API\n\nThe API implements two methods:\n\n- `storeFile()`\n- `retrieveFile()`\n  \n### File storage\n\nTo store a file using the API, the client does the following:\n\n* Select the file to upload\n* Generate SHA256 hash of the file content\n* Capture additional file meta data\n* Send the meta data, SHA256 hash, and file contents to the IPFS node (POST /ipfs)\n\nBehind the scenes, the API does the following:\n\n* Upload the file content to IPFS, which returns the IPFS hash\n* Store the metadata, SHA256 and IPFS hash on the Tangle, which returns a transaction hash\n* Return the Tangle transaction hash to the client\n\n![Data Storage PoC - IOTA/IPFS - Store File](/assets/docs/blueprints/0.1/images/data-storage-store.png)\n\nThe `storeFile()` method takes a JSON object in the following format:\n\n```javascript\nIPFSStoreRequest {\n   /**\n    * The name of the file.\n    */\n   name: string;\n\n   /**\n    * The description of the file.\n    */\n   description: string;\n\n   /**\n    * The size of the file.\n    */\n   size: number;\n\n   /**\n    * The modified date of the file.\n    */\n   modified: Date;\n\n   /**\n    * The sha256 hash of the file.\n    */\n   sha256: string;\n\n   /**\n    * The file data encoded in base64.\n    */\n   data: string;\n}\n```\n\nOn receipt of the JSON object, the file is uploaded to the IPFS node.\n\n```javascript\nimport ipfsClient from \"ipfs-http-client\";\n\nconst buffer = Buffer.from(request.data, \"base64\");\nconst ipfs = ipfsClient(config.ipfs);\nconst addResponse = await ipfs.add(buffer);\n```\n\nThe response from the `add()` method contains the IPFS hash, which is combined with the metadata and the SHA256 hash before being attached to the Tangle.\n\n```javascript\nconst nextAddress = generateAddress(config.seed, 0, 2);\n\nconst tanglePayload = {\n   name: request.name,\n   description: request.description,\n   size: request.size,\n   modified: request.modified,\n   sha256: request.sha256,\n   ipfs: addResponse[0].hash\n};\n\nconst iota = composeAPI({\n        provider: config.provider\n    });\n\nconst trytes = await iota.prepareTransfers(\n   \"9\".repeat(81),\n   [\n\t   {\n\t\t   address: nextAddress,\n\t\t   value: 0,\n\t\t   message: TrytesHelper.toTrytes(tanglePayload)\n\t   }\n   ]);\n\nconst bundle = await iota.sendTrytes(trytes, config.depth, config.mwm);\n   \n```\n\nThe bundle returned from the `sendTrytes()` method contains the transaction hash that's then returned to the client.\n\n### File retrieval\n\nTo retrieve a file and validate its contents the client does the following:\n\n* Request the metadata, SHA256 and IPFS hash using the transaction hash from the API (GET /ipfs)\n* Get the file contents from IPFS using the IPFS hash\n* Perform a SHA256 on the retrieved file content\n* Compare the calculated SHA256 with the one returned from the API\n\n![Data Storage PoC - IOTA/IPFS - Retrieve File](/assets/docs/blueprints/0.1/images/data-storage-retrieve.png)\n\nTo retrieve and validate the file, the transaction hash is read from the Tangle.\n\n```javascript\nconst iota = composeAPI({\n        provider: config.provider\n    });\n\nconst transactions = await iota.getTrytes([request.transactionHash]);\nconst txObject = asTransactionObject(transactions[0]);\nconst ascii = trytesToAscii(txObject.signatureMessageFragment);\nconst payload = JSON.parse(ascii)\n```\n\nThen, the transaction hash is used to request the file from the IPFS node, using any public IPFS gateway such as [Cloudflare](https://cloudflare-ipfs.com/ipfs/:hash)\n\nAssuming the file was returned into a buffer, the file is hashed using a SHA256 algorithm and the resulting hash is compared to the one from the transaction's message.\n\n```javascript\nconst sha256 = crypto.createHash(\"sha256\");\nsha256.update(fileBuffer);\nconst ipfsSha256 = sha256.digest(\"hex\");\nif (ipfsSha256 === payload.sha256) {\n   console.log(\"All Is Well\");\n} else {\n   console.log(\"Oh no, hash does not match\");\n}\n```\n\n## Data security\n\nBecause the IPFS is a distributed web, anyone who has the IPFS hash can download and read the contents of the file. \n\nTo prevent unauthorized entities from reading the data, you could encrypt it before uploading it to the IPFS node.\n\n## Alternative data storage solutions\n\nIn this application, data is uploaded to an IPFS node, however the same principles apply if you were to upload to an alternative data storage solution.\n\nTo use alternative storage solutions such as Amazon S3 or Azure Storage, you just need to upload the data to it with a unique hash (for example the SHA256 hash of the file).\n","title":"App architecture | Tangle Data Storage | アプリ設計図"}}
