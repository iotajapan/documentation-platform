{"path":"docs/iot/0.1/nrf52/how-to-guides/set-up-a-bluetooth-star-network","templateID":1,"sharedPropsHashes":{},"localProps":{"markdown":"# Set up a Bluetooth star network\n\n**Star networks are useful for setting up sensor server networks that communicate through a border router. In this guide, you set up a [6LoWPAN](https://en.wikipedia.org/wiki/6LoWPAN) over Bluetooth Low-Energy star network, using state-of-the-art IoT industry standards.**\n\n## Hardware\n\nTo complete this guide, you need the following:\n\n- [A prepared nRF52832 microcontroller](../introduction/get-started.md)\n- [A BME/BMP 280 sensor](../setup-guides/connect-bosch-sensor.md)\n- A Linux PC or SBC (to use as a border router) that supports Bluetooth version 4.0 or less (USB dongle or integrated) and that is connected to a keyboard and a monitor\n\n## Architecture\n\nIn the star topology, all devices directly communicate with the border router, which acts as a switch to pass on their messages through the Internet.\n\nYou could connect more than one sensor server node to the border router, but in this example we connect only one.\n\n![Star network topology](/assets/docs/iot/0.1/images/star_topology.png)\n\n## Step 1. Set up a sensor server node\n\nBy setting up your microcontroller as a sensor server node, you can allow other devices to request data from it over the Internet. This is useful for applications that need remote access to this data to perform calculations on it.\n\n:::info:\nDue to a bug in RIOT OS, the nRF52832 is the only supported microcontroller at the moment.\n:::\n\n1. Change into the `BLE-environment-sensor/examples/env_sensor_network` directory\n\n    ```bash\n    cd BLE-environment-sensor/examples/env_sensor_network/\n    ```\n\n2. Flash the example onto the microcontroller. Replace the `$BOARD` AND `$USB_PORT` placeholders with the name of your board and the path to your USB-to-UART connector such as `/dev/ttyUSB0`\n\n    ```bash\n    BOARD=BOARD PORT=/dev/ttyUSB0 make flash term\n    ```\n\n    :::info:\n    Search the RIOT documentation to [find the name of your board](https://api.riot-os.org/group__boards.html).\n    :::\n\nIf everything went well, you should see no errors, and if you enter `help`, you should see a list of available commands.\n\nTo see a list of all running processes, do `ps`.\n\nThis is an example application. To support sensors other than the BME/BMP 280, you can edit the `BLE-environment-sensor/examples/env_sensor_network/server.c` and `BLE-environment-sensor/examples/env_sensor_network/sensor.c` files.\n\n## Step 2. Set up a border router\n\nTo allow the sensor servers in a star network to access the Internet, you need a border router that can pass on their data. In this guide, you set up a border router on a Linux device.\n\n## Step 2.1. Install a compatible Linux kernel\n\nDue to [a bug in RIOT OS](https://github.com/RIOT-OS/RIOT/issues/11147), you need to use an older Linux kernel (maximum version 4.12) to set up a border router.\n\n1. Check which version of the Linux kernel your device has\n\n    ```bash\n    uname -a\n    ```\n\n    If you see a version number that's greater than 4.12, continue to step 2. Otherwise, skip the rest of these steps and [install the 6LoWPAN dependencies](#step-2-install-the-6lowpan-dependencies).\n\n2. Select your architecture and download version 4.11.12 of the generic kernel image from the [Ubuntu Linux mainline kernel builds](https://kernel.ubuntu.com/~kernel-ppa/mainline/v4.11.12/)\n\n\n3. Install the kernel\n\n    ```bash\n    sudo dpkg -i linux-image*.deb\n    ```\n\n4. Restart your system while holding the `SHIFT` key until you see the option to select a kernel\n\n5. Select version 4.11.12\n\n## Step 2.2. Install the 6LoWPAN dependencies\n\nTo allow the border router to use 6LoWPAN over BLE, you need to install the software dependencies.\n\n:::info:\nIf you close your session, for example after a reboot, you have to reinstall these dependencies.\n:::\n\n1. Install bluez\n\n    ```bash\n    sudo apt-get install -y bluez\n    ```\n\n2. Log in as the root user\n\n    ```bash\n    sudo su\n    ```\n\n3. Mount the `debugfs` file system\n\n    ```bash\n    mount -t debugfs none /sys/kernel/debug\n    ```\n\n4. Load the Bluetooth 6LoWPAN Linux module\n\n    ```bash\n    modprobe bluetooth_6lowpan\n    ```\n\n5. Enable the 6LoWPAN module\n\n    ```bash\n    echo 1 > /sys/kernel/debug/bluetooth/6lowpan_enable\n    ```\n\n6. Find any available Bluetooth devices\n\n    ```bash\n    hciconfig\n    ```\n\n    You should see something like the following:\n\n    ```bash\n    hci0:   Type: Primary  Bus: UART\n        BD Address: B8:27:EB:57:16:51  ACL MTU: 1021:8  SCO MTU: 64:1\n        UP RUNNING\n        RX bytes:1528 acl:0 sco:0 events:92 errors:0\n        TX bytes:2558 acl:0 sco:0 commands:92 errors:0\n    ```\n\n7. To test your connection to a device, reset one. Replace the `YOUR_DEVICE_ID` placeholder with the ID of your device.\n\n    ```bash\n    hciconfig YOUR_DEVICE_ID reset\n    ```\n\n    For example:\n\n    ```bash\n    hciconfig hci0 reset\n    ```\n\nThe Bluetooth device should reset.\n\n## Step 3. Connect the border router to the sensor server node\n\nTo allow the sensor server node to send and receive data over the Internet, it needs to be connected to a border router.\n\n1. In the serial console of your sensor server node, find the Bluetooth MAC address\n\n    ```bash\n    ifconfig\n    ```\n\n    :::info:\n    The Long HWaddr is the Bluetooth MAC address.\n    :::\n\n2. On your border router, scan for BLE devices\n\n    ```bash\n    hcitool lescan\n    ```\n\n    You should see the Bluetooth MAC address of the sensor server node.\n\n3. Connect your border router to the sensor server node. Replace the `00:AA:BB:XX:YY:ZZ` placeholder with the address of your sensor server node.\n\n    ```bash\n    echo \"connect 00:AA:BB:XX:YY:ZZ 1\" >> /sys/kernel/debug/bluetooth/6lowpan_control\n    ```\n\n    :::info:\n    You can connect more than one sensor server node to your border router by adding other addresses.\n    :::\n\n## Step 4. Request data from the sensor servers\n\nWhen you have a border router and a connected sensor server node, you can request data from the sensor over the Internet, using its IPv6 address.\n\n1. Install the Go programming language on a Linux device such as an [SBC](../../sbc/how-to-guides/install-go-on-sbc.md)\n\n2. Start the server on your microcontroller\n\n    :::info:\n    You need to execute the following command in the serial console of your microcontroller.\n\n    The serial terminal of your microcontroller is opened in the terminal where you executed the `make flash term` command.\n    :::\n\n    ```bash\n    server start\n    ```\n\n    The sensor server node is now running a server application that waits for incoming UDP requests from a client.\n\n    Responses are sent back to the client on the same port from which the request was sent. For example, if the client (the SBC or the PC) sends a UDP packet on port 90 (outgoing-port at the SBC) to port 51037 (incoming-port on the sensor), the sensor server node sends the response to port 90 on the SBC or PC.\n\n3. Clone the client code onto your Linux device\n\n    ```bash\n    git clone https://github.com/iota-community/BLE-environment-sensor-client.git $GOPATH/src/github.com/citrullin/udp_client\n    ```\n\n4. In the `client.go` file, replace the `\"fe80::2ca:46ff:fed3:1967\"` IPv6 address with the IPv6 address of your sensor server node to allow the client to connect to it\n\n    ```cpp\n    var seedSensorConfig = SensorNode{\n        Config: SensorConfig{\n            Address: net.UDPAddr{\n                IP: net.ParseIP(\"fe80::2ca:46ff:fed3:1967\"), Port: 51037, Zone: interfaceName,\n            },\n        },\n    }\n    ```\n\n    :::info:\n    To find out the IPv6 address of your sensor server, execute the `ifconfig` command in the serial interface of the microcontroller.\n    :::\n\n5. Run the client application\n\n    ```bash\n    cd $GOPATH/src/github.com/citrullin/udp_client && go run client.go\n    ```\n\n    You should receive sensor data from the sensor server node.\n\n:::success:Congratulations :tada:\nYou have a Bluetooth star network with a single sensor server node that you can access over the Internet.\n:::\n\n## Troubleshooting\n\nThese are known issues that you may find while following this guide and some suggested steps to resolve them.\n\n### None already mounted or mount point busy\n\nIf you see this response, ignore it. The file system is probably already mounted.\n\n```bash\nmount: /sys/kernel/debug: none already mounted or mount point busy.\n```\n\n### Could not import Google protobuf\n\nIf you see the following error, install python-protobuf for your Linux distribution:\n\n```bash\n*************************************************************\n*** Could not import the Google protobuf Python libraries ***\n*** Try installing package 'python-protobuf' or similar.  ***\n*************************************************************\n```\n\nFor example, for Ubuntu, do the following:\n\n```bash\nsudo apt-get install python-protobuf\n```\n\n## Next steps\n\n[Attach your sensor data to the Tangle](../iota-projects/run-an-environment-to-tangle-app.md).\n","title":"Bluetooth スターネットワークをセットアップする | ハウツーガイド | nRF52 | IoT プロジェクト"}}
