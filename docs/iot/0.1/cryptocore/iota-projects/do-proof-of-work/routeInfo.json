{"path":"docs/iot/0.1/cryptocore/iota-projects/do-proof-of-work","templateID":1,"sharedPropsHashes":{},"localProps":{"markdown":"# Do proof of work for a large bundle\n\n**In this guide, you use the CryptoCore to do proof of work for a bundle that contains 8 zero-value transactions.**\n\n## Prerequisites\n\nTo complete this guide, you need to have completed the [CryptoCore getting started guide](../introduction/get-started.md).\n\nYou also need the following installed on the Raspberry Pi (follow the Ubuntu installation instructions):\n\n- [Node.js](https://github.com/nodesource/distributions/blob/master/README.md#debinstall)\n- [JQ](https://stedolan.github.io/jq/download/)\n\n## Step 1. Get tip transactions from the Tangle\n\nIn this step, you write a script that finds two tip transaction hashes, which you can use later as branch and trunk transactions.\n\n1. Create a directory called `cryptocore-scripts/node-scripts`\n\n    ```bash\n    sudo mkdir ~/cryptocore-scripts/node-scripts\n    ```\n\n2. Install the `core` package\n\n    ```bash\n    cd ~/cryptocore-scripts/node-scripts\n    sudo npm i @iota/core\n    ```\n\n3. Create a file called `get-branch-and-trunk.js`\n\n    ```bash\n    sudo nano get-branch-and-trunk.js\n    ```\n\n4. Copy and paste the following:\n\n    ```js\n    #!/usr/bin/env node\n\n    const Iota = require('@iota/core');\n\n    // Get the first argument that the main script passed to this one\n    // This should be a minimum weight magnitude (14 or 9)\n    const network = process.argv[2];\n\n    // Define a node for each IOTA network\n    const nodes = {\n            devnet: 'https://nodes.devnet.iota.org:443',\n            mainnet: `https://nodes.iota.org:443`\n    }\n\n    // Connect to the correct IOTA network, depending on the user's\n    // selection in the main script\n    if (network === 14) {\n            iota = Iota.composeAPI({\n            provider: nodes.mainnet\n            });\n    } else {\n            iota = Iota.composeAPI({\n            provider: nodes.devnet\n            });\n    }\n\n    // Ask the connected IOTA node for two tip transaction hashes\n    iota.getTransactionsToApprove(3)\n    .then(transactionHashes => {\n        console.log(JSON.stringify(transactionHashes));\n    })\n    .catch(error => {\n        console.log(error)\n    });\n    ```\n\n5. Save and close the file\n\nNow, you're ready to write the code that creates a bundle.\n\n## Step 2. Create a bundle\n\nIn this step, you write a script that creates eight zero-value transactions, chains them into a bundle, and returns the transaction trytes without a proof of work.\n\n1. Create a file called `create-bundle.js`\n\n    ```bash\n    cd ~/cryptocore-scripts/node-scripts\n    sudo nano create-bundle.js\n    ```\n\n2. Install the `converter` package\n\n    ```bash\n    sudo npm i @iota/converter\n    ```\n\n3. Copy and paste the following:\n\n    ```js\n    #!/usr/bin/env node\n\n    const Iota = require('@iota/core');\n    const Converter = require('@iota/converter');\n    const fs = require('fs');\n\n    // Get the first argument that was passed to this script\n    // This should be a minimum weight magnitude (14 or 9)\n    const network = process.argv[2];\n\n    // Define a node for each IOTA network\n    const nodes = {\n            devnet: 'https://nodes.devnet.iota.org:443',\n            mainnet: `https://nodes.iota.org:443`\n    }\n\n    // Connect to the correct IOTA network, depending on the user's\n    // selection in the main script\n    if (network === 14) {\n        iota = Iota.composeAPI({\n            provider: nodes.mainnet\n            });\n    } else {\n        iota = Iota.composeAPI({\n            provider: nodes.devnet\n            });\n    }\n\n    // Define an address to send all transaction to\n    const address = \"CRYPTOCORE99999999999999999999999999999999999999999999999999999999999999999999999\"\n\n    // Create one transfer object for each transaction that you want to send\n    var transfers = [{\n        'address': address,\n        // These transactions do not send IOTA tokens\n        'value': 0,\n        // The `asciiToTrytes()` method supports only basic ASCII characters. As a result, diacritical marks such as accents and umlauts aren't supported and result in an `INVALID_ASCII_CHARS` error.\n        'message': Converter.asciiToTrytes('Hello, this is my first message on a CryptoCore'),\n        'tag': 'CRYPTOCORE'\n    },\n        \n    {\n        'address': address, \n        'value': 0,\n        'message': Converter.asciiToTrytes('Hello, this is my second message on a CryptoCore'),\n        'tag': 'CRYPTOCORE'\n    },\n\n    {\n        'address': address, \n        'value': 0,\n        'message': Converter.asciiToTrytes('Hello, this is my third message on a CryptoCore'),\n        'tag': 'CRYPTOCORE'\n    },\n\n    {\n        'address': address, \n        'value': 0,\n        'message': Converter.asciiToTrytes('Hello, this is my fourth message on a CryptoCore'),\n        'tag': 'CRYPTOCORE'\n    },\n\n    {\n        'address': address, \n        'value': 0,\n        'message': Converter.asciiToTrytes('Hello, this is my fifth message on a CryptoCore'),\n        'tag': 'CRYPTOCORE'\n    },\n\n    {\n        'address': address, \n        'value': 0,\n        'message': Converter.asciiToTrytes('Hello, this is my sixth message on a CryptoCore'),\n        'tag': 'CRYPTOCORE'\n    },\n\n    {\n        'address': address, \n        'value': 0,\n        'message': Converter.asciiToTrytes('Hello, this is my seventh message on a CryptoCore'),\n        'tag': 'CRYPTOCORE'\n    },\n\n    {\n        'address': address, \n        'value': 0,\n        'message': Converter.asciiToTrytes('Hello, this is my eighth message on a CryptoCore'),\n        'tag': 'CRYPTOCORE'\n    }];\n\n    // The library expects a seed, but it is not used because these are zero-value transactions,\n    // therefore this bundle is not signed\n    const seed = \"999999999999999999999999999999999999999999999999999999999999999999999999999999999\"\n\n    // Path to which to save the bundle's transaction trytes\n    const savedTransactionTrytes = \"/home/pi/cryptocore-scripts/attached-transaction-trytes/bundleTrytes.txt\";\n\n    // Chain the transactions into a bundle\n    iota.prepareTransfers(seed, transfers)\n        .then(function(trytes){\n        console.log(JSON.stringify(trytes));\n        })\n        .catch(error => {\n            console.log(error)\n    });\n    ```\n\n4. Save and close the file\n\n## Step 3. Send a bundle\n\nIn this step, you write a script that sends a bundle of transaction trytes with a proof of work to a node.\n\n:::info:\nThe proof of work is done by the CryptoCore in the main script in the next step.\n:::\n\n1. Create a file called `create-bundle.js`\n\n    ```bash\n    cd ~/cryptocore-scripts/node-scripts\n    sudo nano create-bundle.js\n    ```\n\n2. Install the `transaction-converter` package\n\n    ```bash\n    sudo npm i @iota/transaction-converter\n    ```\n\n3. Copy and paste the following:\n\n    ```js\n    #!/usr/bin/env node\n\n    const Iota = require('@iota/core');\n    const Transaction = require('@iota/transaction-converter');\n    const fs  = require('fs');\n\n    // Get the first argument that was passed to this script\n    // This should be a minimum weight magnitude (14 or 9)\n    const network = process.argv[2];\n\n    console.log(network);\n    // Define a node for each IOTA network\n    const nodes = {\n            devnet: 'https://nodes.devnet.iota.org:443',\n            mainnet: `https://nodes.iota.org:443`\n    }\n\n    // Connect to the correct IOTA network, depending on the user's\n    // selection in the main script\n    if (network === '14') {\n            iota = Iota.composeAPI({\n            provider: nodes.mainnet\n            });\n    } else {\n            iota = Iota.composeAPI({\n            provider: nodes.devnet\n            });\n    }\n\n    // Path to the file where the main script saved the transaction trytes\n    const savedTransactionTrytes = \"/home/pi/cryptocore-scripts/attached-transaction-trytes\";\n\n    // Check the file for transaction trytes\n    const data = fs.readFileSync(`${savedTransactionTrytes}/attached_trytes.txt`);\n    const match = data.toString().match(/(?<=({\"trytes\":))\\[\"[^\\]]+\\]/g);\n    const trytes = JSON.parse(match[0]);\n\n    if (!trytes) {\n            console.log(\"No trytes found. Make sure that proof of work was done and check the following file :\");\n            console.log(`${savedTransactionTrytes}/attached_trytes.txt`);\n    }\n\n    // Send the transaction trytes to the connected IOTA node\n    iota.storeAndBroadcast(trytes)\n    .then(trytes => {\n            console.log(\"Successfully attached transactions to the Tangle\");\n            // print the transaction details\n        console.log(\"Tail transaction hash: \");\n        console.log(JSON.stringify(trytes.map(t => Transaction.asTransactionObject(t))[trytes.length-1].hash))\n    })\n    .catch(error => {\n        console.log(error);\n    });\n    ```\n\n4. Save and close the file\n\n## Step 4. Open the serial terminal on the CryptoCore\n\nIn this step, you write a script that opens a serial terminal on the CryptoCore, using Node.js.\n\n1. Install the packages\n\n    ```bash\n    cd ~/cryptocore-scripts/node-scripts\n    sudo npm i serialport\n    ```\n\n3. Create a file called `serial.js`\n\n    ```bash\n    sudo nano serial.js\n    ```\n\n4. Copy and paste the following:\n\n    ```js\n    #!/usr/bin/env node\n\n    const SerialPort = require('serialport');\n    const Readline = require('@serialport/parser-readline');\n    const port = new SerialPort(\"/dev/ttyS0\", { baudRate: 115200 });\n    const parser = new Readline();\n\n    port.pipe(parser);\n\n    parser.on('data', function(data) {\n        console.log(data);\n        port.close(function() {});\n    });\n\n    var myArgs = process.argv.slice(2);\n\n    port.write(myArgs[0])\n    port.write(\"\\r\")\n    ```\n\n5. Save and close the file\n\n## Step 5. Do proof of work on the CryptoCore\n\nIn this step, you use the CryptoCore API to do proof of work for eight transactions, using the data that's returned from the `get-branch-and-trunk.js` and `create-bundle.js` scripts.\n\n1. Create a directory called `cryptocore-scripts`\n\n    ```bash\n    cd ~/scripts\n    sudo mkdir cryptocore-scripts\n    cd cryptocore-scripts\n    ```\n\n2. Create a new file called `do_pow.sh`\n\n    ```bash\n    sudo nano do_pow.sh\n    ```\n\n3. Ask whether the user wants to create a transaction for the Devnet or the Mainnet, and store the answer in the `MWM` variable\n\n    ```bash\n    #!/bin/bash\n\n    read -p \"Are you sending this transaction to the Devnet or the Mainnet? \" MWM\n    ```\n\n4. Use a regular expression to check if the user's answer begins with an 'm' and set the [minimum weight magnitude](/docs/getting-started/0.1/network/minimum-weight-magnitude) (MWM) according to the outcome\n\n    ```bash\n    if [[ $MWM =~ ^[mM] ]]\n    then\n            echo \"Setting minimum weight magnitude to 14 for the Mainnet.\"\n            MWM=14\n    else\n            echo \"Setting minimum weight magnitude to 9 for the Devnet.\"\n            MWM=9\n    fi\n    ```\n\n    :::info:\n    The MWM is essential for the CryptoCore to output a valid proof of work.\n    :::\n\n5. Create a bundle of zero-value transactions by executing the `create-bundle.js` script and save the output to a `trytes` variable\n\n    ```bash\n    echo \"Creating bundle\"\n\n    trytes=$(node ../node-scripts/create-bundle.js $MWM)\n    ```\n\n6. Get two tip transaction hashes from the Tangle by executing the `get-branch-and-trunk.js` script\n\n    ```bash\n    echo \"Getting tip transactions\"\n\n    trunk_and_branch=$(node ../node-scripts/get-branch-and-trunk.js $MWM)\n\n    trunk=$(echo \"$trunk_and_branch\" | jq '.trunkTransaction')\n    branch=$(echo \"$trunk_and_branch\" | jq '.branchTransaction')\n    ```\n\n7. Create an `attachToTangle` API request, pipe it into a serial terminal, and save the result to a file\n\n    ```bash\n    # Get the current Unix epoch in milliseconds for the `attachmentTimestamp` field\n    timestamp=$(date +%s%3N)\n\n    # Make sure a directory exists in which to save the transaction trytes\n    saved_transaction_directory=\"../attached-transaction-trytes\"\n\n    if [ ! -d $saved_transaction_directory ]; then\n        mkdir $saved_transaction_directory\n    fi\n\n    echo \"Doing proof of work on CryptoCore\"\n\n    template='{\"command\":\"attachToTangle\",\"trunkTransaction\": %s,\"branchTransaction\":%s,\"minWeightMagnitude\":%s,\"timestamp\":%s,\"trytes\":%s}'\n\n    json_string=$(printf \"$template\" $trunk $branch $MWM  $timestamp $trytes)\n\n    node ../node-scripts/serial.js \"$json_string\" > $saved_transaction_directory/attached_trytes.txt\n    ```\n\n8. Send the transaction trytes, which now include a proof of work, to the connected IOTA node by executing the `send-bundle.js` script\n\n    ```bash\n    attached_trytes=$(node ../node-scripts/send-bundle.js $MWM)\n\n    echo \"$attached_trytes\"\n    ```\n\n9. Save and close the file and give yourself permission to execute it\n\n    ```bash\n    sudo chmod 777 do_pow.sh\n    ```\n\n10. Run the code and follow the prompts\n\n    ```bash\n    sudo ./do_pow.sh\n    ```\n\n:::success:\nYou have just written a command-line interface (CLI) program that uses the CryptoCore API to do proof of work for eight transactions, then attaches the transaction to the Tangle.\n:::\n\n## Run the code\n\nThese code samples are hosted on [GitHub](https://github.com/JakeSCahill/cryptocore-scripts).\n\nTo get started you need [Git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git) installed on your device.\n\nIf you don't have a JavaScript development environment, or if this is your first time using the JavaScript client library, complete our [getting started guide](/docs/client-libraries/0.1/getting-started/js-quickstart).\n\nIn the command-line, do the following:\n\n1. Clone the repository and change into the `cryptocore-scripts/node-scripts` directory\n\n    ```bash\n    git clone https://github.com/JakeSCahill/cryptocore-scripts\n    cd cryptocore-scripts/node-scripts\n    ```\n\n2. Install the packages\n\n    ```bash\n    sudo npm i\n    ```\n\n    You should see something like the following:\n\n    ```\n    npm notice created a lockfile as package-lock.json. You should commit this file.\n    added 128 packages from 68 contributors and audited 338 packages in 34.171s\n\n    2 packages are looking for funding\n    run `npm fund` for details\n\n    found 0 vulnerabilities\n    ```\n\n3. Run the `do_pow.sh` script and respond to the prompts\n\n    ```bash\n    cd ~/cryptocore-scripts/bash-scripts\n    sudo ./do_pow.sh\n    ```\n\n4. Follow the prompts\n\nYou should see something like the following:\n\n```bash\nWelcome to the spam bundle creator\nAre you sending transactions to the Devnet or the Mainnet? m\nSetting minimum weight magnitude to 14 for the Mainnet.\nCreating bundle\nGetting tip transactions\nDoing proof of work on CryptoCore\n14\nSuccessfully attached transactions to the Tangle\nTail transaction hash:\n\"XDAHIDSSUXIPWPUSVBUWPMYIXWAWPTKLUAHUCVGQRHH9MYGUGVVNVDPRMKULLWTPYQRKSWNTXUQMA9999\"\n```\n\nTo see your bundle on the Tangle, copy the tail transaction hash and paste it into a [Tangle explorer](https://utils.iota.org/).\n\nIf the Tangle explorer doesn't display your transaction after 5 minutes, the node may not have sent your transaction to its neighbors.\n\nTo resend your transaction, you can pass the transaction trytes in the `attached-transaction-trytes/attached_trytes.txt` file to the [`storeAndBroadcast()`](https://github.com/iotaledger/iota.js/tree/next/packages/core#corestoreandbroadcasttrytes-callback) method in the JavaScript client library.\n\n## Next steps\n\n[Generate a random seed](../iota-projects/generate-a-seed.md) on the CryptoCore and store it in the secure memory.","title":"プルーフオブワークを実行する | IOTA プロジェクト | CryptoCore | IoT プロジェクト"}}
